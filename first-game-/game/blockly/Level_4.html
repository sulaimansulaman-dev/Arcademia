<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Blockly + Godot (Level 4)</title>
<script src="blockly.min.js"></script>
<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #fafafa;
  overflow: hidden;
}

/* ‚úÖ Top bar stays on top */
#topbar {
  padding: 10px;
  display: flex;
  flex-wrap: nowrap;
  gap: 10px;
  align-items: center;
  justify-content: flex-start;
  border-bottom: 2px solid #ccc;
  background: #fff;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 100;
  box-sizing: border-box;
}

#switchbar {
  margin-top: 70px;
  padding: 12px;
  display: flex;
  justify-content: flex-start;
  background: #fff;
  border-bottom: 2px solid #ccc;
  position: fixed;
  width: 100%;
  z-index: 9;
  top: 20px;
  box-sizing: border-box;
}

.hint {
  color: #555;
  font-size: 14px;
  margin-left: auto;
  font-style: italic;
  flex: 1 1 100%;
  text-align: left;
}

#blocklyDiv {
  position: absolute;
  top: 160px;
  left: 0;
  bottom: 0;
  right: 0;
}

button {
  padding: 12px 28px;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: white;
}
button:hover, button:focus {
  background: #f0f0f0;
  outline: 2px solid #666;
}

@media (max-width: 700px) {
  #topbar { justify-content: center; }
  .hint {
    order: 99;
    font-size: 13px;
    text-align: center;
  }
}

/* Help overlay */
#helpOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.92);
  color: white;
  overflow-y: auto;
  display: none;
  z-index: 9999;
  box-sizing: border-box;
}
#helpContent {
  max-width: 900px;
  margin: 40px auto;
  padding: 30px;
}
#helpOverlay h2 { margin-top: 0; font-size: min(36px, 6vw); }
#helpOverlay h3 { margin-bottom: 8px; margin-top: 24px; font-size: min(24px, 4.5vw); }
#helpOverlay p { font-size: min(18px, 3.8vw); line-height: 1.6; }
#helpOverlay .example {
  background: #333;
  padding: 12px;
  border-radius: 8px;
  margin: 8px 0;
  font-family: monospace;
  font-size: min(16px, 3.5vw);
}
#helpButtons { display: flex; gap: 10px; margin-top: 30px; flex-wrap: wrap; }
#helpButtons button {
  font-size: min(18px, 4vw);
  padding: 12px 24px;
  background: white;
  color: black;
  border-radius: 6px;
}

/* Block warning */
#blockWarningOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  color: white;
  z-index: 10000;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 20px;
  box-sizing: border-box;
}
#blockWarningOverlay h2 { font-size: 34px; margin-bottom: 20px; }
#blockWarningOverlay p { font-size: 22px; margin-top: 10px; }
#blockWarningOverlay button {
  margin-top: 20px;
  padding: 12px 24px;
  font-size: 20px;
  cursor: pointer;
  border-radius: 6px;
  border: none;
  background: white;
  color: black;
}
</style>
</head>
<body>

<div id="topbar">
  <button id="run">üöÄ Run in Godot</button>
  <button id="clear">üóëÔ∏è Clear</button>
  <button id="reset">üîÑ Reset Level</button>
  <button id="back">‚¨ÖÔ∏è Back</button>
  <button id="help">‚ùì Help</button>
</div>

<!-- üîÄ Switch bar under top buttons -->
<div id="switchbar">
  <button id="switch">üîÄ Switch to Logic/Loop Blocks</button>
</div>

<div id="blocklyDiv"></div>

<div id="helpOverlay">
  <div id="helpContent">
    <h2>Level 4 ‚Äì Help</h2>
    <p>Use all blocks including while loops to guide your astronaut until all spaceship parts are collected.</p>
    <h3>Start</h3><p>Marks the beginning of your program.</p><div class="example">Example: start ‚Üí move right</div>
    <h3>Move Right</h3><p>Move forward 1 block.</p><div class="example">Example: move right</div>
    <h3>Move Right and Jump</h3><p>Move forward and jump obstacles.</p><div class="example">Example: move right and jump 4 blocks</div>
    <h3>If/Else Block</h3><p>Choose between two actions depending on a condition.</p>
    <div class="example">Example: if gap ahead ‚Üí jump else ‚Üí move right</div>
    <h3>While Loop</h3><p>Repeat actions while a condition is true.</p>
    <div class="example">Example: while no spaceship part ‚Üí move right 1</div>
    <div id="helpButtons"><button id="closeHelp">Close Help</button></div>
  </div>
</div>

<div id="blockWarningOverlay">
  <div>
    <h2>Please use these blocks</h2>
    <p id="missingBlocksText"></p>
    <button id="closeBlockWarning">OK</button>
  </div>
</div>

<script>
/* Define blocks */
Blockly.defineBlocksWithJsonArray([
  { "type":"start","message0":"start","nextStatement":null,"colour":210,"hat":"cap" },
  { "type":"move_right","message0":"move right","previousStatement":null,"nextStatement":null,"colour":120 },
  { "type":"move_right_and_jump","message0":"move right and jump %1 blocks",
    "args0":[{"type":"field_dropdown","name":"STEPS","options":[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]]}],
    "previousStatement":null,"nextStatement":null,"colour":180 },
  { "type":"if_else_block","message0":"if %1 then %2 do %3 else %4 do %5",
    "args0":[
      {"type":"field_dropdown","name":"COND","options":[["wall ahead","wall_ahead"],["No wall ahead","no_wall_ahead"]]},
      {"type":"input_dummy"},{"type":"input_statement","name":"DO"},
      {"type":"input_dummy"},{"type":"input_statement","name":"ELSE"}],
    "previousStatement":null,"nextStatement":null,"colour":330 },
  { "type":"controls_while","message0":"while %1",
    "args0":[{"type":"field_dropdown","name":"COND","options":[["spaceship part","spaceship_part"]]}],
    "message1":"do %1","args1":[{"type":"input_statement","name":"DO"}],
    "previousStatement":null,"nextStatement":null,"colour":260 }
]);

/* Toolboxes */
const toolboxMovement = {
  "kind":"flyoutToolbox",
  "contents":[
    {"kind":"block","type":"start"},
    {"kind":"block","type":"move_right"},
    {"kind":"block","type":"move_right_and_jump"}
  ]
};
const toolboxLogic = {
  "kind":"flyoutToolbox",
  "contents":[
    {"kind":"block","type":"if_else_block"},
    {"kind":"block","type":"controls_while"}
  ]
};

let currentToolbox = "movement";
const workspace = Blockly.inject('blocklyDiv', {
  toolbox: toolboxMovement,
  trashcan: true,
  media: 'media/',
  horizontalLayout: true,
  toolboxPosition: 'top',
  zoom: { controls: true, startScale: 1.2, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 }
});

/* Switch toolbox */
document.getElementById("switch").addEventListener("click",()=>{
  if(currentToolbox==="movement"){
    workspace.updateToolbox(toolboxLogic);
    currentToolbox="logic";
    document.getElementById("switch").innerText="üîÄ Switch to Movement Blocks";
  } else {
    workspace.updateToolbox(toolboxMovement);
    currentToolbox="movement";
    document.getElementById("switch").innerText="üîÄ Switch to Logic/Loop Blocks";
  }
});

/* Build Program */
function buildProgram(block){
  const commands=[];
  while(block){
    if(block.type==="move_right") commands.push({cmd:"move_right",steps:1});
    else if(block.type==="move_right_and_jump"){
      const steps=parseInt(block.getFieldValue("STEPS"));
      commands.push({cmd:"move_right_and_jump",steps});
    }
    else if(block.type==="controls_while"){
      const inner=block.getInputTargetBlock("DO");
      commands.push({cmd:"while",cond:block.getFieldValue("COND"),do:buildProgram(inner)});
    }
    else if(block.type==="if_else_block"){
      const doBlock=block.getInputTargetBlock("DO");
      const elseBlock=block.getInputTargetBlock("ELSE");
      commands.push({cmd:"if_else",cond:block.getFieldValue("COND"),do:buildProgram(doBlock),else:buildProgram(elseBlock)});
    }
    block=block.getNextBlock();
  }
  return commands;
}

function getProgram(){
  const starts=workspace.getBlocksByType("start",false);
  if(!starts.length) return[];
  return buildProgram(starts[0].getNextBlock());
}

/* Check Required Blocks */
function checkAllBlocksUsed(){
  const required=["start","move_right","move_right_and_jump","if_else_block","controls_while"];
  return required.filter(t=>workspace.getBlocksByType(t,false).length===0);
}

function sendToGodot(payload){
  if(window.ipc?.postMessage) window.ipc.postMessage(JSON.stringify(payload));
  else console.warn("Not inside Godot WebView; payload:",payload);
}

/* Block warning */
function showBlockWarning(missing){
  document.getElementById('missingBlocksText').innerText = missing.join(", ");
  document.getElementById('blockWarningOverlay').style.display='flex';
}
document.getElementById('closeBlockWarning').addEventListener('click',()=> {
  document.getElementById('blockWarningOverlay').style.display='none';
});

/* Buttons */
document.getElementById("run").addEventListener("click",()=>{
  const missing=checkAllBlocksUsed();
  if(missing.length>0){ showBlockWarning(missing); return; }
  sendToGodot({type:"program",commands:getProgram()});
});
document.getElementById("clear").addEventListener("click",()=>Blockly.getMainWorkspace().clear());
document.getElementById("reset").addEventListener("click",()=>sendToGodot({type:"reset_level"}));
document.getElementById("back").addEventListener("click",()=>sendToGodot({type:"back"}));

/* Help overlay */
const helpOverlay=document.getElementById("helpOverlay");
document.getElementById("help").addEventListener("click",()=>helpOverlay.style.display="block");
document.getElementById("closeHelp").addEventListener("click",()=>helpOverlay.style.display="none");

/* ‚úÖ Keyboard shortcuts */
document.addEventListener("keydown",(e)=>{
  if(e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return; // ignore typing
  switch(e.key.toLowerCase()){
    case "r": document.getElementById("run").click(); break;
    case "c": document.getElementById("clear").click(); break;
    case "l": document.getElementById("reset").click(); break;
    case "b": document.getElementById("switch").click(); break;
    case "h": document.getElementById("help").click(); break;
    case "a": document.getElementById("back").click(); break;
  }
});

window.addEventListener('load',()=>{
  const missing=checkAllBlocksUsed();
  if(missing.length>0) showBlockWarning(missing);
});


</script>

</body>
</html>
