<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Blockly + Godot (Level 4)</title>
<script src="blockly.min.js"></script>
<style>
html, body { height:100%; margin:0; font-family:system-ui,sans-serif; }
#topbar { padding:8px; display:flex; gap:8px; align-items:center; border-bottom:1px solid #ddd; }
#blocklyDiv { position:absolute; height:calc(100% - 65px); width:100%; }
button { padding:6px 12px; cursor:pointer; border:1px solid #ccc; border-radius:4px; background:white; }
button:hover { background:#f0f0f0; }
.hint { color:#666; font-size:12px; }
#helpOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:white; overflow-y:auto; display:none; z-index:9999; box-sizing: border-box; }
#helpContent { max-width:800px; margin:0 auto; padding:20px; box-sizing:border-box; }
#helpOverlay h2 { margin-top:0; font-size:min(28px,5vw); }
#helpOverlay h3 { margin-bottom:5px; margin-top:20px; font-size:min(20px,4vw); }
#helpOverlay p { font-size:min(16px,3.5vw); line-height:1.5; }
#helpOverlay .example { background:#333; padding:10px; border-radius:6px; margin:5px 0; font-family:monospace; font-size:min(14px,3vw); }
#helpButtons { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
#helpButtons button { font-size:min(16px,4vw); padding:10px 20px; }
#blockWarningOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); color:white; z-index:10000; display:flex; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box; }
#blockWarningOverlay h2 { font-size:32px; margin-bottom:20px; }
#blockWarningOverlay p { font-size:24px; margin-top:10px; }
#blockWarningOverlay button { margin-top:20px; padding:10px 20px; font-size:20px; cursor:pointer; border-radius:6px; border:none; background:white; color:black; }
</style>
</head>
<body>

<div id="topbar">
  <button id="run">üöÄ Run in Godot</button>
  <button id="clear">üóëÔ∏è Clear</button>
  <button id="reset">üîÑ Reset Level</button>
  <button id="back">‚¨ÖÔ∏è Back</button>
  <button id="help">‚ùì Help</button>
  <span class="hint">Use move right, move right & jump, if/else, and while loops.</span>
</div>

<div id="blocklyDiv"></div>

<div id="helpOverlay">
  <div id="helpContent">
    <h2>Level 4 ‚Äì Help</h2>
    <p>Use all blocks including while loops to guide your astronaut until all spaceship parts are collected.</p>

    <h3>Start</h3><p>Marks the beginning of your program.</p><div class="example">Example: start ‚Üí move right</div>
    <h3>Move Right</h3><p>Move forward 1 block.</p><div class="example">Example: move right</div>
    <h3>Move Right and Jump</h3><p>Move forward and jump obstacles for a chosen number of blocks.</p><div class="example">Example: move right and jump 4 blocks</div>
    <h3>If/Else Block</h3><p>Choose between two actions depending on a condition.</p><div class="example">Example: if gap ahead ‚Üí move right and jump else ‚Üí move right</div>
    <h3>While Loop</h3><p>Keep performing actions while the condition is true (e.g., while no spaceship part).</p><div class="example">Example: while no spaceship part ‚Üí move right 1</div>

    <div id="helpButtons"><button id="closeHelp">Close Help</button></div>
  </div>
</div>

<div id="blockWarningOverlay">
  <div>
    <h2>Please use these blocks</h2>
    <p id="missingBlocksText"></p>
    <button id="closeBlockWarning">OK</button>
  </div>
</div>

<script>
Blockly.defineBlocksWithJsonArray([
  { "type":"start","message0":"start","nextStatement":null,"colour":210,"hat":"cap" },
  { "type":"move_right","message0":"move right","previousStatement":null,"nextStatement":null,"colour":120 },
  { 
    "type":"move_right_and_jump",
    "message0":"move right and jump %1 blocks",
    "args0":[
      {
        "type":"field_dropdown",
        "name":"STEPS",
        "options":[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]]
      }
    ],
    "previousStatement":null,"nextStatement":null,"colour":180 
  },
  { "type":"if_else_block","message0":"if %1 then %2 do %3 else %4 do %5",
    "args0":[
      {"type":"field_dropdown","name":"COND","options":[["wall ahead","wall_ahead"],["No wall ahead","no_wall_ahead"]]},
      {"type":"input_dummy"},
      {"type":"input_statement","name":"DO"},
      {"type":"input_dummy"},
      {"type":"input_statement","name":"ELSE"}
    ],
    "previousStatement":null,"nextStatement":null,"colour":330 
  },
  { "type":"controls_while","message0":"while %1","args0":[{"type":"field_dropdown","name":"COND","options":[["spaceship part","spaceship_part"]]}],
    "message1":"do %1","args1":[{"type":"input_statement","name":"DO"}],
    "previousStatement":null,"nextStatement":null,"colour":260 
  }
]);

const toolbox = {
  "kind":"flyoutToolbox",
  "contents":[
    {"kind":"block","type":"start"},
    {"kind":"block","type":"move_right"},
    {"kind":"block","type":"move_right_and_jump"},
    {"kind":"block","type":"if_else_block"},
    {"kind":"block","type":"controls_while"}
  ]
};

const workspace = Blockly.inject('blocklyDiv',{toolbox,trashcan:true});

function buildProgram(block){
  const commands=[];
  while(block){
    if(block.type==="move_right") {
      commands.push({cmd:"move_right",steps:1});
    }
    else if(block.type==="move_right_and_jump"){
      const steps=parseInt(block.getFieldValue("STEPS"));
      commands.push({cmd:"move_right_and_jump",steps});
    }
    else if(block.type==="controls_while"){
      const inner=block.getInputTargetBlock("DO");
      commands.push({cmd:"while",cond:block.getFieldValue("COND"),do:buildProgram(inner)});
    }
    else if(block.type==="if_else_block"){
      const doBlock=block.getInputTargetBlock("DO");
      const elseBlock=block.getInputTargetBlock("ELSE");
      commands.push({cmd:"if_else",cond:block.getFieldValue("COND"),do:buildProgram(doBlock),else:buildProgram(elseBlock)});
    }
    block=block.getNextBlock();
  }
  return commands;
}

function getProgram(){
  const starts=workspace.getBlocksByType("start",false);
  if(!starts.length) return[];
  return buildProgram(starts[0].getNextBlock());
}

function checkAllBlocksUsed(){
  const required=["start","move_right","move_right_and_jump","if_else_block","controls_while"];
  return required.filter(t=>workspace.getBlocksByType(t,false).length===0);
}

function sendToGodot(payload){
  if(window.ipc?.postMessage) window.ipc.postMessage(JSON.stringify(payload));
  else console.warn("Not inside Godot WebView; payload:",payload);
}

function showBlockWarning(missing){
  document.getElementById('missingBlocksText').innerText = missing.join(", ");
  document.getElementById('blockWarningOverlay').style.display='flex';
}

document.getElementById('closeBlockWarning').addEventListener('click',()=>{
  document.getElementById('blockWarningOverlay').style.display='none';
});

document.getElementById("run").addEventListener("click",()=>{
  const missing=checkAllBlocksUsed();
  if(missing.length>0){ showBlockWarning(missing); return; }
  sendToGodot({type:"program",commands:getProgram()});
});

document.getElementById("clear").addEventListener("click",()=>Blockly.getMainWorkspace().clear());
document.getElementById("reset").addEventListener("click",()=>sendToGodot({type:"reset_level"}));
document.getElementById("back").addEventListener("click",()=>sendToGodot({type:"back"}));

const helpOverlay=document.getElementById("helpOverlay");
document.getElementById("help").addEventListener("click",()=>helpOverlay.style.display="block");
document.getElementById("closeHelp").addEventListener("click",()=>helpOverlay.style.display="none");

// Show block warning on first load
window.addEventListener('load',()=>{
  const missing=checkAllBlocksUsed();
  if(missing.length>0) showBlockWarning(missing);
});
</script>

</body>
</html>
