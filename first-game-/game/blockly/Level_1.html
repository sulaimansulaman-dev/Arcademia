<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Blockly + Godot (Level 1 - Arcade)</title>
  <script src="blockly.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
    #topbar { padding: 8px; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid #ddd; }
    #blocklyDiv { position: absolute; height: calc(100% - 65px); width: 100%; }
    button { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: white; }
    button:hover, button:focus { background: #f0f0f0; outline: 2px solid #666; }
    .hint { color: #666; font-size: 12px; }

    /* Help overlay */
    #helpOverlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      color: white;
      overflow-y: auto;
      display: none;
      z-index: 9999;
      box-sizing: border-box;
    }
    #helpContent { max-width: 800px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
    #helpOverlay h2 { margin-top: 0; font-size: min(28px, 5vw); }
    #helpOverlay h3 { margin-bottom: 5px; margin-top: 20px; font-size: min(20px, 4vw); }
    #helpOverlay p { font-size: min(16px, 3.5vw); line-height: 1.5; }
    #helpOverlay .example { background: #333; padding: 10px; border-radius: 6px; margin: 5px 0; font-family: monospace; font-size: min(14px, 3vw); }
    #helpButtons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    #helpButtons button { font-size: min(16px, 4vw); padding: 10px 20px; }

    /* Warning overlay */
    #blockWarningOverlay {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      color: white; z-index: 10000;
      display: flex; justify-content: center; align-items: center;
      text-align: center; padding: 20px; box-sizing: border-box;
    }
    #blockWarningOverlay h2 { font-size: 32px; margin-bottom: 20px; }
    #blockWarningOverlay p { font-size: 24px; margin-top: 10px; }
    #blockWarningOverlay button {
      margin-top: 20px; padding: 10px 20px;
      font-size: 20px; cursor: pointer;
      border-radius: 6px; border: none; background: white; color: black;
    }

    /* Arcade cursor */
    #arcadeCursor {
      position: fixed; top: 50%; left: 50%;
      width: 24px; height: 24px;
      margin-left: -12px; margin-top: -12px;
      border: 3px solid red; border-radius: 50%;
      pointer-events: none; z-index: 10001;
    }
    body { cursor: none; } /* Hide system mouse */
  </style>
</head>
<body>
  <div id="topbar">
    <button id="run">üöÄ Run in Godot</button>
    <button id="clear">üóëÔ∏è Clear</button>
    <button id="reset">üîÑ Reset Level</button>
    <button id="back">‚¨ÖÔ∏è Back</button>
    <button id="help">‚ùì Help</button>
    <span class="hint">Stack blocks under <b>start</b>, then click Run.</span>
  </div>
  <div id="blocklyDiv"></div>

  <!-- Red cursor -->
  <div id="arcadeCursor"></div>

  <!-- Help Overlay -->
  <div id="helpOverlay">
    <div id="helpContent">
      <h2>Level 1 ‚Äì Help</h2>
      <p>Use these blocks to guide your astronaut across the level.</p>
      <h3>Start</h3><p>Marks the beginning of your program.</p>
      <div class="example">Example: start ‚Üí move right (4)</div>
      <h3>Move Right</h3><p>Moves your astronaut forward.</p>
      <div class="example">Example: move right (3)</div>
      <h3>Move Right and Jump</h3><p>Moves forward and jumps.</p>
      <div class="example">Example: move right and jump (5)</div>
      <div id="helpButtons"><button id="closeHelp">Close Help</button></div>
    </div>
  </div>

  <!-- Block Warning Overlay -->
  <div id="blockWarningOverlay">
    <div>
      <h2>Please use these blocks</h2>
      <p id="missingBlocksText"></p>
      <button id="closeBlockWarning">OK</button>
    </div>
  </div>

<script>
  // Define blocks
  Blockly.defineBlocksWithJsonArray([
    { "type": "start","message0": "start","nextStatement": null,"colour": 210,"hat": "cap" },
    { "type": "move_right","message0": "move right %1 blocks",
      "args0":[{"type":"field_dropdown","name":"STEPS","options":[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]]}],
      "previousStatement": null,"nextStatement": null,"colour": 120 },
    { "type": "move_right_and_jump","message0": "move right and jump %1 blocks",
      "args0":[{"type":"field_dropdown","name":"STEPS","options":[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]]}],
      "previousStatement": null,"nextStatement": null,"colour": 180 }
  ]);

  // Toolbox
  const toolbox = {
    "kind":"flyoutToolbox",
    "contents":[
      { "kind":"block", "type":"start" },
      { "kind":"block", "type":"move_right" },
      { "kind":"block", "type":"move_right_and_jump" }
    ]
  };

  // Workspace
  const workspace = Blockly.inject('blocklyDiv',{
    toolbox, trashcan:true, media:'media/',
    zoom:{ controls:true, wheel:true, startScale:1.3, maxScale:3, minScale:0.3, scaleSpeed:1.2 }
  });

  // Build program
  function buildProgram(){
    const starts=workspace.getBlocksByType('start',false);
    if(!starts.length) return [];
    let block=starts[0].getNextBlock();
    const commands=[];
    while(block){
      if(block.type==="move_right") commands.push({cmd:"move_right",steps:parseInt(block.getFieldValue("STEPS"))});
      if(block.type==="move_right_and_jump") commands.push({cmd:"move_right_and_jump",steps:parseInt(block.getFieldValue("STEPS"))});
      block=block.getNextBlock();
    }
    return commands;
  }

  function checkAllBlocksUsed(){
    const required=["start","move_right","move_right_and_jump"];
    return required.filter(t=>workspace.getBlocksByType(t,false).length===0);
  }

  function sendToGodot(payload){
    if(window.ipc?.postMessage) window.ipc.postMessage(JSON.stringify(payload));
    else console.warn("Not inside Godot WebView; payload:",payload);
  }

  function showBlockWarning(missing){
    document.getElementById('missingBlocksText').innerText=missing.join(", ");
    document.getElementById('blockWarningOverlay').style.display='flex';
  }

  // UI buttons
  document.getElementById('closeBlockWarning').onclick=()=>{document.getElementById('blockWarningOverlay').style.display='none';};
  document.getElementById('run').onclick=()=>{
    const missing=checkAllBlocksUsed();
    if(missing.length>0){showBlockWarning(missing);return;}
    sendToGodot({type:'program',commands:buildProgram()});
  };
  document.getElementById('clear').onclick=()=>workspace.clear();
  document.getElementById('reset').onclick=()=>sendToGodot({type:'reset_level'});
  document.getElementById('back').onclick=()=>sendToGodot({type:'back'});
  document.getElementById('help').onclick=()=>{document.getElementById('helpOverlay').style.display='block';};
  document.getElementById('closeHelp').onclick=()=>{document.getElementById('helpOverlay').style.display='none';};

  window.onload=()=>{
    const missing=checkAllBlocksUsed();
    if(missing.length>0) showBlockWarning(missing);
  };

  // Cursor logic
  let cursor={x:window.innerWidth/2,y:window.innerHeight/2};
  const cursorEl=document.getElementById('arcadeCursor');
  let mouseDown=false;

  function updateCursor(){ cursorEl.style.left=cursor.x+"px"; cursorEl.style.top=cursor.y+"px"; }

  function dispatchAt(type,buttons){
    const el=document.elementFromPoint(cursor.x,cursor.y);
    if(!el) return;
    const pe=new PointerEvent(type,{bubbles:true,clientX:cursor.x,clientY:cursor.y,pointerId:1,pointerType:"mouse",isPrimary:true,buttons});
    el.dispatchEvent(pe);
    const me=new MouseEvent(type.replace("pointer","mouse"),{bubbles:true,clientX:cursor.x,clientY:cursor.y,buttons});
    el.dispatchEvent(me);
  }

  function clickElementUnderCursor(){
    const el=document.elementFromPoint(cursor.x,cursor.y);
    if(!el) return;
    el.focus();
    el.click();
  }

  function moveCursor(dx, dy){
    cursor.x=Math.min(window.innerWidth,Math.max(0,cursor.x+dx));
    cursor.y=Math.min(window.innerHeight,Math.max(0,cursor.y+dy));

    const el=document.elementFromPoint(cursor.x,cursor.y);
    if(el){
        el.dispatchEvent(new PointerEvent('pointerover',{bubbles:true,clientX:cursor.x,clientY:cursor.y,pointerId:1,pointerType:"mouse",isPrimary:true,buttons:mouseDown?1:0}));
        el.dispatchEvent(new PointerEvent('pointermove',{bubbles:true,clientX:cursor.x,clientY:cursor.y,pointerId:1,pointerType:"mouse",isPrimary:true,buttons:mouseDown?1:0}));
        if(el.classList.contains('blocklyDropdownText')) el.focus();
    }

    if(!mouseDown){
        Blockly.hideChaff();
        Blockly.getMainWorkspace().highlightBlock(null);
    }

    updateCursor();
  }

  // Arcade keyboard mapping
  window.addEventListener('keydown',(e)=>{
    switch(e.key){
      case "ArrowUp": moveCursor(0,-20); break;
      case "ArrowDown": moveCursor(0,20); break;
      case "ArrowLeft": moveCursor(-20,0); break;
      case "ArrowRight": moveCursor(20,0); break;

      case "z":
      case "Enter":
        const el=document.elementFromPoint(cursor.x,cursor.y);
        if(!el) break;
        // Open dropdown if over block field
        if(el.classList.contains('blocklyDropdownText')){ el.click(); break; }
        // Buttons
        if(el.tagName==="BUTTON"){ clickElementUnderCursor(); break; }
        // Normal grab/drop
        if(!mouseDown){ mouseDown=true; dispatchAt("pointerdown",1); }
        else{ mouseDown=false; dispatchAt("pointerup",0); Blockly.getMainWorkspace().highlightBlock(null); }
        break;

      case "x":
      case "Escape": dispatchAt("contextmenu",0); break;

      case "a": document.getElementById('run').click(); break;
      case "s": document.getElementById('clear').click(); break;
    }
  });

  updateCursor();
</script>
</body>
</html>
